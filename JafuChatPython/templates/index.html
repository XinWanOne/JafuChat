<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JafuChat ({{base}})</title>

    <!-- Include any CSS stylesheets here -->
    <style>
        body, html {
          height: 100%;
          margin: 0;
          display: flex;
          flex-direction: column;
        }
        h2, p {
          margin-left: 10px;
          margin-top: 0px;
        }
        .titleArea {
          background: #ffddd2;
        }
        .content {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: #edf6f9; /* Light grey background */
        }
        .input-container {
          padding: 10px;
          display: flex;
          margin: 10px;
          border-radius: 10px;
          background: #e29578; /* Slightly darker grey background */
        }
        label {
          align-self: center;
        }
        input[type="text"] {
          display: inline-block;
          margin-left: 10px;
          padding: 10px;
          flex-grow: 1;
          box-sizing: border-box; /* Ensures padding does not increase the width */
        }
        button {
          margin-left: 10px;
          padding: 10px;
        }
        /* Styles for the feedback form */
        #feedback-form {
          background: #fff;
          padding: 20px;
          margin: 20px;
          border: 1px solid #ccc;
          border-radius: 10px;
        }
        #feedback-form h3, #feedback-form h4 {
          margin-top: 0;
        }
        /* Variable for question font type */
        :root {
          --question-font: Arial, sans-serif;
        }
        .feedback-questions {
          display: flex;
          justify-content: space-between;
        }
        .feedback-questions .left-column,
        .feedback-questions .right-column {
          width: 48%;
          font-family: var(--question-font);
        }
        .feedback-questions label {
          display: block;
          margin: 5px 0;
        }
        #feedback-form textarea {
          width: 100%;
          box-sizing: border-box;
        }
    </style>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>
<body>
    <div id="headSpace" class="titleArea">
        <h2>
            <img width="24" height="24" style="margin-top:10px;" src="{{ url_for('static', filename='images/logo.png') }}">
            JafuChat ({{base}})
            <span style="float:right;margin-right:10px">
                <a href="./?settings=base">âš™</a>
            </span>
        </h2>

        <p>
            {% for link in links %}
                <a href="{{ link.href }}">{{ link.text }}</a>
            {% endfor %}
            <span style="float:right;margin-right:10px">
                <small class="text-muted">
                    Using
                    <i>{{model}}</i>
                </small>
            </span>
        </p>
        <form id="qaForm" class="input-container">
            <label for="query">Question:</label>
            <input type="text" id="query" name="query" placeholder="Ask JafuChat about '{{base}}'"><br>
            <button type="submit" id="submitButton">Submit</button>
            <button type="button" id="clearButton">Clear</button>
        </form>
    </div>

    <div id="answerContainer" class="content">
        <div id="introduction" class="content">
            <h3>Welcome to Jason's AI For You chat (JafuChat)</h3>
            <p style="max-width: 400px;">
                You can ask questions for the selected directory.
                The LLM will combine general knowledge with the content of the documents to provide the answer.
                It will list references within the documents where possible.
            </p>
            <p>
                <img src="{{ url_for('static', filename='images/big_logo.png') }}">
            </p>
            <p><br><br>
                Ask a question.
            </p>
        </div>
    </div>

    <!-- Feedback Form -->
    <div id="feedback-form" style="display: none; margin-top: 20px;">
        <h3>Please provide your feedback:</h3>
        <form id="feedbackForm">
            <div class="feedback-questions">
                <div class="left-column">
                    <h4>The Content of the Answer</h4>
                    <label><input type="checkbox" name="answer_accuracy" value="Accurate"> Accurate</label>
                    <label><input type="checkbox" name="answer_accuracy" value="Not Accurate"> Not Accurate</label>
                    <label><input type="checkbox" name="answer_completeness" value="Complete"> Complete</label>
                    <label><input type="checkbox" name="answer_completeness" value="Incomplete"> Incomplete</label>
                </div>
                <div class="right-column">
                    <h4>Reference URLs</h4>
                    <label><input type="checkbox" name="reference_accuracy" value="Accurate"> Accurate</label>
                    <label><input type="checkbox" name="reference_accuracy" value="Not Accurate"> Not Accurate</label>
                    <label><input type="checkbox" name="reference_completeness" value="Complete"> Complete</label>
                    <label><input type="checkbox" name="reference_completeness" value="Incomplete"> Incomplete</label>
                </div>
            </div>

            <h4>Additional Comments</h4>
            <textarea name="comments" rows="4" cols="50"></textarea><br><br>

            <button type="submit">Submit</button>
            <button type="button" id="clearFeedback">Clear</button>
        </form>
    </div>

    <!-- Include any JavaScript code here -->
    <script>
        // Variables to store the last question and answer
        let lastQuestion = '';
        let lastAnswer = '';

        // Function to handle question submission
        document.getElementById('qaForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            let query = document.getElementById('query').value.trim();
            if (query === "") return;

            disableForm();

            try {
                let response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query, base: "{{base}}" })
                });

                let data = await response.json();
                displayAnswer(query, data.answer);

            } catch (error) {
                console.error('Error:', error);
            } finally {
                enableForm();
            }
        });

        // Function to handle clear button click
        document.getElementById('clearButton').addEventListener('click', async function() {
            try {
                clearHistory();  // Clear the UI first

                let response = await fetch('/api/clear_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                let data = await response.json();
                if (data.status !== 'success') {
                    console.error('Failed to clear history on server');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        function disableForm() {
            document.getElementById('query').disabled = true;
            document.getElementById('submitButton').disabled = true;
            document.getElementById('clearButton').disabled = true;
            let introductionContainer = document.getElementById('introduction');
            if (introductionContainer) {
                introductionContainer.style.background = '#ddd6d9';
            }
            let answerContainer = document.getElementById('answerContainer');
            answerContainer.style.background = '#ddd6d9';
        }

        function enableForm() {
            document.getElementById('query').value = ''
            document.getElementById('query').disabled = false;
            document.getElementById('submitButton').disabled = false;
            document.getElementById('clearButton').disabled = false;
            let answerContainer = document.getElementById('answerContainer');
            answerContainer.style.background = '#edf6f9';
        }

        function displayAnswer(question, answer) {
            let introductionContainer = document.getElementById('introduction');
            if (introductionContainer) {
                introductionContainer.style.display= "none";
            }

            let answerContainer = document.getElementById('answerContainer');
            answerContainer.innerHTML += `
                <h2>Question:</h2>
                <p>${question}</p>
                <h2>Answer:</h2>
                <p>${answer}</p>
            `;
            answerContainer.scrollTop = answerContainer.scrollHeight;

            // Store the last question and answer
            lastQuestion = question;
            lastAnswer = answer;

            // Show the feedback form
            document.getElementById('feedback-form').style.display = 'block';
        }

        function clearHistory() {
            let answerContainer = document.getElementById('answerContainer');

            if (answerContainer) {
                answerContainer.innerHTML = `
                    <div id="introduction" class="content">
                        <h3>Welcome to Jason's AI For You chat (JafuChat)</h3>
                        <p style="max-width: 400px;">
                            You can ask questions for the selected directory.
                            The LLM will combine general knowledge with the content of the documents to provide the answer.
                            It will list references within the documents where possible.
                        </p>
                        <p>
                            <img src="{{ url_for('static', filename='images/big_logo.png') }}">
                        </p>
                        <p><br><br>
                            Ask a question.
                        </p>
                    </div>
                `;
            } else {
                console.error('Answer container not found');
            }

            // Hide the feedback form
            document.getElementById('feedback-form').style.display = 'none';

            // Reset the last question and answer
            lastQuestion = '';
            lastAnswer = '';
        }

        // Function to handle feedback form submission
        document.getElementById('feedbackForm').addEventListener('submit', function(event) {
            event.preventDefault();

            // Collect feedback data
            var answerAccuracy = [];
            document.querySelectorAll('input[name="answer_accuracy"]:checked').forEach(function(el) {
                answerAccuracy.push(el.value);
            });

            var answerCompleteness = [];
            document.querySelectorAll('input[name="answer_completeness"]:checked').forEach(function(el) {
                answerCompleteness.push(el.value);
            });

            var referenceAccuracy = [];
            document.querySelectorAll('input[name="reference_accuracy"]:checked').forEach(function(el) {
                referenceAccuracy.push(el.value);
            });

            var referenceCompleteness = [];
            document.querySelectorAll('input[name="reference_completeness"]:checked').forEach(function(el) {
                referenceCompleteness.push(el.value);
            });

            var comments = document.querySelector('textarea[name="comments"]').value;

            // Collect question and answer
            var question = lastQuestion;
            var answer = lastAnswer;

            // Prepare data to send
            var feedbackData = {
                question: question,
                answer: answer,
                answer_accuracy: answerAccuracy,
                answer_completeness: answerCompleteness,
                reference_accuracy: referenceAccuracy,
                reference_completeness: referenceCompleteness,
                comments: comments
            };

            // Send feedback data to server
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(feedbackData)
            })
            .then(function(response) {
                if (response.ok) {
                    alert('Thank you for your feedback!');
                    document.getElementById('feedback-form').style.display = 'none';
                    document.getElementById('feedbackForm').reset();
                } else {
                    alert('There was an error submitting your feedback.');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
            });
        });

        // Function to handle clearing the feedback form
        document.getElementById('clearFeedback').addEventListener('click', function() {
            document.getElementById('feedbackForm').reset();
        });
    </script>
</body>
</html>
